این مجموعه دستورات، یک محیط محدود و کنترل‌شده برای یک کاربر خاص در لینوکس ایجاد می‌کند. هدف اصلی این است که کاربری به نام `system` بسازیم که هنگام ورود (login)، به جای دسترسی به شل استاندارد (مانند `bash`)، به صورت خودکار یک اسکریپت مشخص (`cli.sh`) را با دسترسی ریشه (`root`) اجرا کند.

-----

### ۱. ایجاد و آماده‌سازی اسکریپت اصلی

این اسکریپت، برنامه اصلی شماست که می‌خواهید کاربر `system` آن را اجرا کند.

```bash
# 1. با ویرایشگر vim یک فایل جدید به نام cli.sh ایجاد کنید.
#    شما می‌توانید از ویرایشگرهای دیگر مانند nano هم استفاده کنید.
vim cli.sh

# 2. محتوای اسکریپت خود را در این فایل وارد و ذخیره کنید.
#    (این بخش محتوای اسکریپت شماست)

# 3. به فایل cli.sh دسترسی اجرایی (executable) بدهید.
#    بدون این دسترسی، سیستم عامل اجازه اجرای فایل را نمی‌دهد.
chmod +x cli.sh
```

**نکته:** فرض بر این است که شما بعداً این فایل را به مسیر `/opt/cli/cli.sh` منتقل می‌کنید.

-----

### ۲. ایجاد کاربر جدید

یک کاربر جدید به نام `system` برای اجرای اسکریپت ایجاد می‌کنیم.

```bash
# یک کاربر جدید به نام system در سیستم ایجاد می‌کند.
# سیستم از شما می‌خواهد که یک رمز عبور برای این کاربر تعیین کنید.
sudo adduser system
```

-----

### ۳. ساخت اسکریپت Wrapper برای اجرا با دسترسی ریشه (root)

از آنجایی که نمی‌خواهیم به کاربر `system` دسترسی کامل `sudo` به همه دستورات را بدهیم، یک اسکریپت واسط (Wrapper) می‌سازیم. وظیفه این اسکریپت فقط این است که اسکریپت اصلی ما را با دستور `sudo` فراخوانی کند.

```bash
# یک فایل جدید در مسیر /opt/cli/ با نام run-storex-as-root.sh ایجاد می‌کند.
# نکته: اگر دایرکتوری /opt/cli وجود ندارد، ابتدا آن را با دستور sudo mkdir -p /opt/cli بسازید.
sudo vim /opt/cli/run-storex-as-root.sh
```

محتوای زیر را داخل این فایل قرار دهید:

```bash
#!/bin/bash
# این اسکریپت به عنوان یک واسط عمل کرده و اسکریپت اصلی را با دسترسی sudo اجرا می‌کند.
exec sudo /opt/cli/cli.sh
```

سپس فایل را ذخیره کرده و دسترسی اجرایی به آن بدهید:

```bash
# به اسکریپت Wrapper دسترسی اجرایی می‌دهد.
sudo chmod +x /opt/cli/run-storex-as-root.sh
```

-----

### ۴. تنظیم اسکریپت Wrapper به عنوان Shell پیش‌فرض کاربر

در این مرحله، کاری می‌کنیم که هر زمان کاربر `system` وارد سیستم شد، به جای باز شدن ترمینال `bash`، مستقیماً اسکریپت Wrapper ما اجرا شود.

```bash
# 1. مسیر اسکریپت Wrapper را به لیست شل‌های مجاز سیستم در فایل /etc/shells اضافه می‌کند.
#    این کار برای امنیت سیستم ضروری است.
echo "/opt/cli/run-storex-as-root.sh" | sudo tee -a /etc/shells

# 2. شل پیش‌فرض کاربر system را به اسکریپت Wrapper تغییر می‌دهد.
sudo usermod -s /opt/cli/run-storex-as-root.sh system
```

-----

### ۵. پیکربندی دسترسی Sudo بدون نیاز به رمز عبور

برای اینکه اسکریپت Wrapper بتواند بدون درخواست رمز عبور، اسکریپت اصلی را با `sudo` اجرا کند، باید یک قانون مشخص در فایل تنظیمات `sudoers` تعریف کنیم.

```bash
# 1. کاربر system را به گروه sudo اضافه می‌کند تا اجازه استفاده از دستور sudo را داشته باشد.
sudo usermod -aG sudo system

# 2. فایل sudoers را با ویرایشگر امن visudo باز می‌کند.
#    هشدار: هرگز این فایل را با ویرایشگرهای معمولی مثل vim یا nano ویرایش نکنید.
#    استفاده از visudo از خطاهای نوشتاری که می‌تواند سیستم شما را قفل کند، جلوگیری می‌کند.
sudo visudo
```

سپس خط زیر را به **انتهای** فایلی که باز می‌شود اضافه کنید:

```
system ALL=(ALL) NOPASSWD: /opt/cli/cli.sh
```

**توضیح این خط:**

  * `system`: این قانون برای کاربر `system` اعمال می‌شود.
  * `ALL=(ALL)`: کاربر می‌تواند این دستور را از هر ترمینال و به عنوان هر کاربری اجرا کند.
  * `NOPASSWD:`: برای اجرای دستور مشخص شده، نیازی به وارد کردن رمز عبور نیست.
  * `/opt/cli/cli.sh`: دستوری که اجرای آن بدون رمز عبور مجاز است.

-----

### ۶. نصب بسته‌های پیش‌نیاز

این دستورات، بسته‌ها و ابزارهای نرم‌افزاری مورد نیاز برای اجرای صحیح اسکریپت‌ها و مدیریت سیستم را نصب می‌کنند.

```bash
# ابتدا لیست بسته‌های مخازن نرم‌افزاری را به‌روزرسانی کرده
# و سپس تمام بسته‌های لیست شده را نصب می‌کند.
sudo apt update && sudo apt install -y \
bash sudo coreutils util-linux lsb-release \
net-tools iproute2 ifupdown \
smartmontools \
lshw lsof pciutils usbutils dmidecode parted gdisk \
tar gzip bzip2 \
sysstat \
systemd systemd-sysv \
dialog whiptail bc jq curl wget nano
```

این بسته‌ها شامل ابزارهای اساسی سیستم (`coreutils`)، ابزارهای شبکه (`net-tools`)، ابزارهای مدیریت دیسک (`smartmontools`, `parted`) و سایر ابزارهای کاربردی می‌باشند.

-----

### ۷. تنظیمات زمان و منطقه زمانی سیستم

در نهایت، منطقه زمانی سیستم را تنظیم کرده و سرویس همگام‌سازی خودکار زمان (NTP) را غیرفعال می‌کنیم. این کار ممکن است در شرایطی که نیاز به کنترل دستی زمان دارید، مفید باشد.

```bash
# 1. منطقه زمانی سیستم را روی تهران تنظیم می‌کند.
sudo timedatectl set-timezone Asia/Tehran

# 2. سرویس‌های همگام‌سازی زمان را متوقف و غیرفعال می‌کند.
#    این کار باعث می‌شود زمان سیستم به صورت خودکار با سرورهای اینترنتی هماهنگ نشود.
sudo systemctl stop ntp
sudo systemctl disable ntp
sudo systemctl stop systemd-timesyncd
sudo systemctl disable systemd-timesyncd

# 3. قابلیت NTP را در timedatectl غیرفعال می‌کند.
sudo timedatectl set-ntp no
```
